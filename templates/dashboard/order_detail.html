{% extends "dashboard/base_dashboard.html" %}
{% block title %}Basalto · {{ order.order_number }}{% endblock %}
{% block page_title %}Orden {{ order.order_number }}{% endblock %}
{% block page_sub %}Seguimiento y actualización rápida{% endblock %}

{% block content %}

<div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
  <a class="btn" href="{% url 'orders:dashboard_orders' %}">← Volver</a>
  <div class="pill">Cliente: <b style="color:var(--ink)">{{ order.full_name }}</b></div>
  <div class="pill">Total: <b style="color:var(--ink)">${{ order.total }}</b></div>
  <div class="pill">Estado: <b style="color:var(--ink)">{{ order.get_status_display }}</b></div>
</div>

<!-- ===== Timeline ===== -->
<style>
  .timeline{
    margin-top:14px;
    border:1px solid var(--line);
    border-radius: var(--r2);
    background:#fff;
    padding:14px 14px 10px;
  }
  .timeline h3{
    margin:0 0 12px;
    font-family:var(--serif);
    font-size:18px;
    letter-spacing:.02em;
  }
  .steps{
    display:grid;
    grid-template-columns: repeat(6, 1fr);
    gap:10px;
  }
  @media (max-width: 980px){ .steps{ grid-template-columns: repeat(3, 1fr);} }
  @media (max-width: 520px){ .steps{ grid-template-columns: repeat(2, 1fr);} }

  .step{
    border:1px solid var(--line);
    border-radius: 14px;
    padding:10px 10px 9px;
    background:#fff;
    position:relative;
  }
  .step .k{
    font-size:11px;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:var(--muted);
  }
  .step .dot{
    width:8px;height:8px;border-radius:999px;
    background: var(--line);
    display:inline-block;
    margin-right:8px;
    transform: translateY(-1px);
  }
  .step.active{
    border-color: rgba(17,17,17,.30);
    box-shadow: 0 10px 30px rgba(0,0,0,.05);
  }
  .step.active .dot{ background: var(--ink); }
  .step.done{
    background: #fbf7ef;
  }
  .step.done .dot{ background: var(--ink); opacity:.75; }
  .hint{
    margin-top:10px;
    color:var(--muted);
    font-size:12.5px;
    line-height:1.6;
  }
</style>

<div class="timeline">
  <h3>Estado (timeline)</h3>
  <div class="steps">
    {% for s in timeline %}
      <div class="step {% if s.is_done %}done{% endif %}{% if s.is_active %} active{% endif %}">
        <div class="k"><span class="dot"></span>{{ s.label }}</div>
      </div>
    {% endfor %}
  </div>
  <div class="hint">
    Tip: cambiá el estado desde la tarjeta de la derecha y se actualizará el timeline.
    (Si una orden se marca como <b>Cancelada</b>, se gestiona fuera del flujo.)
  </div>
</div>


<!-- ===== Layout 2 columnas: items + cliente ===== -->
<div class="grid" style="grid-template-columns: 1.2fr .8fr; margin-top:14px;">
  <!-- Items -->
  <div class="card">
    <div class="card-h">
      <div>
        <h2>Items</h2>
        <p>Productos dentro de la orden</p>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Variante</th>
          <th>Precio</th>
          <th>Qty</th>
          <th>Total línea</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td>
            <b>{{ it.title }}</b>
            <div class="muted" style="font-size:12px;margin-top:4px;">{{ it.fabric }}</div>
          </td>
          <td class="muted">
            Manga: {{ it.sleeve }}<br>
            Color: {{ it.color }} · Talla: {{ it.size }}
          </td>
          <td class="mono">${{ it.unit_price }}</td>
          <td>
            <form method="post" action="{% url 'orders:dashboard_orderitem_qty' it.id %}" style="display:flex;gap:8px;align-items:center;">
              {% csrf_token %}
              <input class="input" name="qty" type="number" min="1" value="{{ it.qty }}" style="width:86px;">
              <button class="btn" type="submit">OK</button>
            </form>
          </td>
          <td class="mono"><b>${{ it.line_total }}</b></td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="muted" style="padding:18px;">No hay items.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <div style="display:flex;gap:12px;flex-wrap:wrap;padding:12px 14px;border-top:1px solid var(--line);">
      <div class="pill">Subtotal: <b style="color:var(--ink)">${{ order.subtotal }}</b></div>
      <div class="pill">Envío: <b style="color:var(--ink)">${{ order.shipping }}</b></div>
      <div class="pill">Total: <b style="color:var(--ink)">${{ order.total }}</b></div>
    </div>
  </div>

  <!-- Cliente + acciones -->
  <div class="card">
    <div class="card-h">
      <div>
        <h2>Cliente & envío</h2>
        <p>Dirección, notas y estado</p>
      </div>
    </div>

    <div style="padding:14px 14px 6px;">
      <div class="muted" style="font-size:12px;letter-spacing:.10em;text-transform:uppercase;">Dirección</div>
      <div style="margin-top:6px;line-height:1.6;">
        <b>{{ order.full_name }}</b><br>
        <span class="muted">{{ order.phone }}</span><br><br>
        {{ order.address_line1 }}<br>
        {% if order.address_line2 %}{{ order.address_line2 }}<br>{% endif %}
        {% if order.department %}{{ order.department }}{% endif %}{% if order.city %}, {{ order.city }}{% endif %}
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
        <button class="btn" type="button"
          onclick="copyText('{{ order.phone|escapejs }}')">Copiar teléfono</button>
      
        <button class="btn" type="button"
          onclick="copyText('{{ order.address_line1|escapejs }}{% if order.address_line2 %}, {{ order.address_line2|escapejs }}{% endif %}, {{ order.department|escapejs }}{% if order.city %}, {{ order.city|escapejs }}{% endif %}')">
          Copiar dirección
        </button>
      
        {% if order.tracking_code %}
          <button class="btn" type="button"
            onclick="copyText('{{ order.tracking_code|escapejs }}')">Copiar tracking</button>
        {% endif %}
      </div>
      

      <div class="muted" style="margin-top:14px;font-size:12px;letter-spacing:.10em;text-transform:uppercase;">Notas</div>
      <div class="muted" style="margin-top:6px;line-height:1.6;">{{ order.notes|default:"—" }}</div>
    </div>

    <div style="border-top:1px solid var(--line); padding:14px;">
      <form method="post" action="{% url 'orders:dashboard_order_update' order.id %}" style="display:grid;gap:10px;">
        {% csrf_token %}
        <label class="muted" style="font-size:11px;letter-spacing:.10em;text-transform:uppercase;">Estado</label>
        <select name="status">
          {% for key,label in STATUS_CHOICES %}
            <option value="{{ key }}" {% if order.status == key %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>

        <label class="muted" style="font-size:11px;letter-spacing:.10em;text-transform:uppercase;">Tracking</label>
        <input class="input" name="tracking_code" value="{{ order.tracking_code }}" placeholder="Ej: SV123456789">

        <button class="btn primary" type="submit">Guardar</button>
      </form>
    </div>
  </div>
</div>

{% endblock %}
